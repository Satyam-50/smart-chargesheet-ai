import os
import streamlit as st
from dotenv import load_dotenv

from preprocess import clean_noisy_text
from extractor import extract_case_summary
from classifier import classify_crime_type
from checklist_engine import load_checklists, run_missing_items_check
from file_handler import extract_text_from_file


# ================= PAGE CONFIG (MUST BE FIRST STREAMLIT COMMAND) =================
st.set_page_config(
    page_title="Smart Chargesheet Assistant",
    layout="wide"
)

# ================= LOAD ENV =================
load_dotenv(dotenv_path=".env")
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")

# DEBUG: Check if app loaded
st.write("тЬЕ **App Loaded Successfully**")
st.write(f"ЁЯФС API Key Loaded: {'Yes' if GEMINI_API_KEY else 'No (MISSING!)'}")


# ================= MAIN APP =================
def main():
    st.title("тЪЦя╕П Smart Chargesheet Assistant")
    st.markdown("AI-powered structured chargesheet analysis system")

    # ================= LOAD CHECKLIST =================
    try:
        checklists = load_checklists("checklists.json")
    except Exception as e:
        st.error(f"тЭМ Error loading checklists.json: {e}")
        return

    # ================= INPUT SECTION =================
    st.markdown("### ЁЯУД Upload Chargesheet (PDF, DOCX, Image with OCR) or paste text")
    
    col1, col2, col3 = st.columns([0.6, 0.2, 0.2])
    
    with col1:
        uploaded_file = st.file_uploader(
            "Upload file (PDF, DOCX, PNG, JPG, etc.):",
            type=["pdf", "docx", "doc", "txt", "png", "jpg", "jpeg", "bmp", "gif"]
        )
    
    with col2:
        if st.button("ЁЯУЛ Load Dummy Data"):
            st.session_state.raw_text = """
FIR NUMBER: 456/2024
рджрд┐рдирд╛рдВрдХ: 15-03-2024
рдкреБрд▓рд┐рд╕ рд╕реНрдЯреЗрд╢рди: рдХреЛрддрд╡рд╛рд▓реА, рдЗрдВрджреМрд░ (рдордзреНрдп рдкреНрд░рджреЗрд╢)
рд╕рдВрдЬреНрдЮреЗрдп рдЕрдкрд░рд╛рдз: IPC 379, 380, 411, 413 рдХреЗ рддрд╣рдд

рдЖрд░реЛрдкреАрдпреЛрдВ рдХреЗ рдирд╛рдо:
1. рд░рд╛рдо рдХреБрдорд╛рд░ рд╢рд░реНрдорд╛, рдЙрдореНрд░ 32 рд╡рд░реНрд╖, рдкрддрд╛: рдореЛрддреА рдирдЧрд░, рдЗрдВрджреМрд░
2. рдЕрдирд┐рд▓ рдкрдЯреЗрд▓, рдЙрдореНрд░ 28 рд╡рд░реНрд╖, рдкрддрд╛: рд░рд╛рдЬ рдкрде, рдЗрдВрджреМрд░
3. рдкреНрд░рдХрд╛рд╢ рд╕реЛрдиреА (рд╣рд░рд╛рдмрд╣рд╛рджреБрд░реА), рдЙрдореНрд░ 35 рд╡рд░реНрд╖, рдкрддрд╛: рдЫреЛрдЯрд╛ рдмрд╛рдЬрд╛рд░

рд╢рд┐рдХрд╛рдпрддрдХрд░реНрддрд╛:
рдХреГрд╖реНрдгрд╛ рд╡рд░реНрдорд╛, рд╡реНрдпрд╡рд╕рд╛рдпреА, рдЖрдпреБ 45 рд╡рд░реНрд╖, рдкрддрд╛: рдХрдорд▓рд╛ рдирдЧрд░, рдЗрдВрджреМрд░

рдШрдЯрдирд╛ рдХрд╛ рд╡рд┐рд╡рд░рдг:
рджрд┐рдирд╛рдВрдХ 12-03-2024 рдХреЛ рд░рд╛рддреНрд░рд┐ рд▓рдЧрднрдЧ 23:30 рдмрдЬреЗ рд╢рд┐рдХрд╛рдпрддрдХрд░реНрддрд╛ рдХреГрд╖реНрдгрд╛ рд╡рд░реНрдорд╛ рдЕрдкрдиреЗ рдХрд╛рд░реНрдпрд╛рд▓рдп (рд░реЗрдбреА рдореЗрдб рдХреЙрдЯрди рдЯреЗрдХреНрд╕рдЯрд╛рдЗрд▓ рд╢реЛрд░реВрдо) рдореЗрдВ рд╕рд╛рдорд╛рди рдХреА рдЧрд┐рдирддреА рдХрд░ рд░рд╣реЗ рдереЗред рдЖрд░реЛрдкреА рд░рд╛рдо рдХреБрдорд╛рд░ рдиреЗ рдЕрдкрдиреЗ рд╕рд╛рдереА рдЕрдирд┐рд▓ рдкрдЯреЗрд▓, рдкреНрд░рдХрд╛рд╢ рд╕реЛрдиреА рдХреЛ рд▓реЗрдХрд░ рд╢реЛрд░реВрдо рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдХрд┐рдпрд╛ред рд░рд╛рдо рдХреБрдорд╛рд░ рдХреЗ рдкрд╛рд╕ рдПрдХ рдмреБрд▓реЗрдЯ рдкрд┐рд╕реНрддреМрд▓ (.32 рдХреИрд▓рд┐рдмрд░) рдереА рдЬрд┐рд╕реЗ рдЙрд╕рдиреЗ рд╢рд┐рдХрд╛рдпрддрдХрд░реНрддрд╛ рдХреЗ рд╕реАрдиреЗ рдкрд░ рддрд╛рди рджрд┐рдпрд╛ред рд╢рд┐рдХрд╛рдпрддрдХрд░реНрддрд╛ рднрдпрднреАрдд рд╣реЛ рдЧрдпрд╛ред рдЖрд░реЛрдкрд┐рдпреЛрдВ рдиреЗ рд╢реЛрд░реВрдо рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рд╛рдорд╛рди рдХрд╛ рдЕрдкрд╣рд░рдг рдХрд┐рдпрд╛:

рдЬрдкреНрдд рдХреА рдЧрдИ рд╡рд╕реНрддреБрдПрдВ:
1. рд╕реЛрдиреЗ рдХреА рдореЛрд╣рд░реЗрдВ: 250 рдЧреНрд░рд╛рдо (рдХреБрд▓ рдореВрд▓реНрдп рд▓рдЧрднрдЧ тВ╣12,50,000)
2. рдЪрд╛рдВрджреА рдХреЗ рдЖрднреВрд╖рдг: 500 рдЧреНрд░рд╛рдо (тВ╣30,000)
3. рдХрдкрдбрд╝реЛрдВ рдХрд╛ рд╕реНрдЯреЙрдХ: 500 рдкреАрд╕ premium cotton fabric (тВ╣5,00,000)
4. рдирдХрдж рд░реБрдкрдпреЗ: тВ╣2,45,000
5. рдбрд┐рдЬрд╝рд┐рдЯрд▓ рдХреИрдореЗрд░рд╛: 2 рдкреАрд╕ Canon EOS (тВ╣1,00,000)
6. Laptop: Dell XPS 13 (тВ╣1,20,000)
7. Mobile phones: 5 рдкреАрд╕ (Samsung, Apple) (тВ╣3,50,000)
8. рдХрд╛рд░: Maruti Swift (рд░рдЬрд┐рд╕реНрдЯреНрд░реЗрд╢рди рдирдВрдмрд░: MP-04-AB-1234)

рдХреБрд▓ рдЕрдиреБрдорд╛рдирд┐рдд рдиреБрдХрд╕рд╛рди: рд▓рдЧрднрдЧ тВ╣24,95,000

рдЧрд┐рд░рдлреНрддрд╛рд░реА рд╡рд┐рд╡рд░рдг:
17-03-2024 рдХреЛ рдЕрдкрд░рд╛рдз рдХреА рд╕реВрдЪрдирд╛ рдкрд░ рддрддреНрдХрд╛рд▓ рдЕрдиреНрд╡реЗрд╖рдг рд╢реБрд░реВ рдХрд┐рдпрд╛ рдЧрдпрд╛ред рдордзреНрдп рдкреНрд░рджреЗрд╢ рдкреБрд▓рд┐рд╕ рдФрд░ рдЗрдВрджреМрд░ рдкреБрд▓рд┐рд╕ рдмрд▓ рдиреЗ рд╕рдВрдпреБрдХреНрдд рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХреАред рдЖрд░реЛрдкреА рд░рд╛рдо рдХреБрдорд╛рд░ рдХреЛ 18-03-2024 рдХреЛ рдЕрд▓реАрд░рд╛рдЬрдкреБрд░ рдЬрдВрдЧрд▓ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рдЧрд┐рд░рдлреНрддрд╛рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ред рдЕрдирд┐рд▓ рдкрдЯреЗрд▓ рдХреЛ 19-03-2024 рдХреЛ рдЦрдВрдбрд╡рд╛ рдореЗрдВ рдкрдХрдбрд╝рд╛ рдЧрдпрд╛ред рдкреНрд░рдХрд╛рд╢ рд╕реЛрдиреА рдиреЗ 20-03-2024 рдХреЛ рд╕реНрд╡рдпрдВ рдХреЛ рдЖрддреНрдорд╕рдорд░реНрдкрд┐рдд рдХрд░ рджрд┐рдпрд╛ред

рдЧрд┐рд░рдлреНрддрд╛рд░реА рдореЗрдореЛ:
рддреАрдиреЛрдВ рдЖрд░реЛрдкрд┐рдпреЛрдВ рдХреА рдЧрд┐рд░рдлреНрддрд╛рд░реА рдХреЗ рд╕рдордп рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╡рд╕реНрддреБрдПрдВ рдмрд░рд╛рдордж рдХреА рдЧрдИрдВ:
- рд░рд╛рдо рдХреБрдорд╛рд░ рдХреЗ рдХрдмреНрдЬреЗ рд╕реЗ: .32 рдХреИрд▓рд┐рдмрд░ рдмреБрд▓реЗрдЯ рдкрд┐рд╕реНрддреМрд▓ (рд▓рд╛рдЗрд╕реЗрдВрд╕ рдирдВрдмрд░: 2021-IND-4567), 8 bullets, рдирдХрдж тВ╣50,000, рд╕реЛрдиреЗ рдХреЗ рд╕рд┐рдХреНрдХреЗ 50 рдЧреНрд░рд╛рдо
- рдЕрдирд┐рд▓ рдкрдЯреЗрд▓ рдХреЗ рдХрдмреНрдЬреЗ рд╕реЗ: рдирдХрдж тВ╣1,20,000, рдЪрд╛рдВрджреА рдХреЗ рдЖрднреВрд╖рдг 150 рдЧреНрд░рд╛рдо, рдХрдкрдбрд╝реЛрдВ рдХрд╛ рд╕рд╛рдорд╛рди
- рдкреНрд░рдХрд╛рд╢ рд╕реЛрдиреА рдХреЗ рдХрдмреНрдЬреЗ рд╕реЗ: Maruti Swift рдХрд╛рд░ (stolen), 2 mobile phones, Laptop

рдЬрдкреНрддреА рдореЗрдореЛ (Seizure Memo):
рджрд┐рдирд╛рдВрдХ: 20-03-2024
рдЬрдкреНрддреА рд╕реНрдЯреЗрд╢рди: рдХреЛрддрд╡рд╛рд▓реА, рдЗрдВрджреМрд░
рдкрдВрдЪрд╛рдпрдд рдХреЗ рд╕рд╛рдХреНрд╖реА: 
1. рд╡рд┐рдЬрдп рд╕рд┐рдВрд╣ (рджреБрдХрд╛рдирджрд╛рд░) - рдореЛрдмрд╛рдЗрд▓: 9876543210
2. рдЕрдЬрдп рд╡рд░реНрдорд╛ (рдирд┐рд░реНрдорд╛рдг рдареЗрдХреЗрджрд╛рд░) - рдореЛрдмрд╛рдЗрд▓: 9988776655

рдЧрд╡рд╛рд╣реЛрдВ рдХреЗ рдмрдпрд╛рди:
1. рд╢рд┐рдХрд╛рдпрддрдХрд░реНрддрд╛ рдХреГрд╖реНрдгрд╛ рд╡рд░реНрдорд╛: рдЖрд░реЛрдкрд┐рдпреЛрдВ рдиреЗ рдкрд┐рд╕реНрддреМрд▓ рджрд┐рдЦрд╛рдХрд░ рдзрдордХреА рджреАред рдореИрдВ рдЕрдкрдиреА рдЬрд╛рди рдмрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЪреБрдк рд░рд╣рд╛ред рдореБрдЭреЗ рдкреВрд░рд╛ рд╡рд┐рд╢реНрд╡рд╛рд╕ рд╣реИ рдХрд┐ рд░рд╛рдо рдХреБрдорд╛рд░ рд╣реА рдЗрд╕ рдЕрдкрд░рд╛рдз рдХрд╛ рдореБрдЦреНрдп рдЖрд░реЛрдкреА рд╣реИред

2. рдкреНрд░рддреНрдпрдХреНрд╖рджрд░реНрд╢реА рдЧрд┐рд░реАрд╢ рдкрдЯреЗрд▓ (рд╕рдбрд╝рдХ рдХреЗ рдХрд┐рдирд╛рд░реЗ рдХреА рджреБрдХрд╛рди): рдореИрдВрдиреЗ рджреЗрдЦрд╛ рдХрд┐ рддреАрди рд╡реНрдпрдХреНрддрд┐ рдХрд╛рд░ рдореЗрдВ рд╕рд╛рдорд╛рди рднрд░рддреЗ рд╣реБрдП рднрд╛рдЧ рдЧрдПред

3. рдкрдбрд╝реЛрд╕реА рд╡рд░реНрд╖рд╛ рддреНрд░рд┐рдкрд╛рдареА: рдореИрдВрдиреЗ рд░рд╛рдд рдХреЛ рдЧреЛрд▓реА рдЪрд▓рдиреЗ рдХреА рдЖрд╡рд╛рдЬрд╝ рд╕реБрдиреА рдереАред рд╢рд┐рдХрд╛рдпрддрдХрд░реНрддрд╛ рдЪрд┐рд▓реНрд▓рд╛ рд░рд╣реЗ рдереЗред

рдЪрд┐рдХрд┐рддреНрд╕рд╛ рд╡рд┐рд╡рд░рдг (MLC Report):
рдкрд░реАрдХреНрд╖рд╛ рджрд┐рдирд╛рдВрдХ: 13-03-2024
рд╢рд┐рдХрд╛рдпрддрдХрд░реНрддрд╛ рдХреГрд╖реНрдгрд╛ рд╡рд░реНрдорд╛:
- рд╕реАрдиреЗ рдкрд░ рдЧрд╣рд░рд╛ рдЦрд░реЛрдВрдЪ рдХрд╛ рдирд┐рд╢рд╛рди
- рдорд╛рдирд╕рд┐рдХ рдЖрдШрд╛рдд
- рдХреЛрдИ рдЧрдВрднреАрд░ рдЪреЛрдЯ рдирд╣реАрдВ

рдбреЙрдХреНрдЯрд░ рдХреЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░: рдбреЙ. рд░рд╛рдЬреЗрд╢ рд╢рд░реНрдорд╛, рд╕рд░рдХрд╛рд░реА рдЪрд┐рдХрд┐рддреНрд╕рд╛ рдорд╣рд╛рд╡рд┐рджреНрдпрд╛рд▓рдп, рдЗрдВрджреМрд░

рдкреБрд▓рд┐рд╕ рдЕрдиреНрд╡реЗрд╖рдг рд░рд┐рдкреЛрд░реНрдЯ (FSL Report):
Forensic Science Laboratory, рднреЛрдкрд╛рд▓ рд╕реЗ:
- рдмреБрд▓реЗрдЯ рдкрд┐рд╕реНрддреМрд▓: рдкрдВрдЬреАрдХреГрдд (рд▓рд╛рдЗрд╕реЗрдВрд╕ рдХреЗ рдЕрдиреБрд╕рд╛рд░)
- рдлрд┐рдВрдЧрд░рдкреНрд░рд┐рдВрдЯ: 3 рдЖрд░реЛрдкрд┐рдпреЛрдВ рдХреЗ рдореЗрд▓ рд╕реЗ 100% match
- DNA рдЯреЗрд╕реНрдЯ: рдХрдкрдбрд╝реЛрдВ рдкрд░ рд╕рднреА рддреАрдиреЛрдВ рдХреЗ DNA рдХреЗ рдирд┐рд╢рд╛рди рдорд┐рд▓реЗ
- рдлреЛрдЯреЛрдЧреНрд░рд╛рдлреА: рдЧрд┐рд░рдлреНрддрд╛рд░реА рд╕реНрдерд▓ рдХреА рдлреЛрдЯреЛ (12 рдлреЛрдЯреЛ)

рдЕрдкрд░рд╛рдз рд╕реНрдерд▓ рдкрд░ рдЦреЛрдЬ (Site Plan):
рд╢реЛрд░реВрдо рдХрд╛ layout:
- рдореБрдЦреНрдп рдкреНрд░рд╡реЗрд╢ рджреНрд╡рд╛рд░ (рд╕рд╛рдордиреЗ рд╡рд╛рд▓реА рд╕рдбрд╝рдХ рд╕реЗ)
- рд╢реЛрд░реВрдо рдХреНрд╖реЗрддреНрд░ (30 x 20 рдлреАрдЯ)
- рдкрд┐рдЫрд▓рд╛ рдЧреЛрджрд╛рдо
- рдКрдкрд░ рдХреА рдордВрдЬрд┐рд▓ рдХрд╛рд░реНрдпрд╛рд▓рдп
- CCTV рдХреИрдореЗрд░реЗ: 4 (рд╕рднреА рд╕реБрд░рдХреНрд╖рд┐рдд)

рдЧрд┐рд░рдлреНрддрд╛рд░реА рдХреЗ рдмрд╛рдж рдХреА рдХрд╛рд░реНрд░рд╡рд╛рдИ:
- 21-03-2024: рдорд╛рдирдиреАрдп рдиреНрдпрд╛рдпрд╛рдзреАрд╢ рдХреЗ рд╕рдордХреНрд╖ рдкреНрд░рд╕реНрддреБрдд
- рдиреНрдпрд╛рдпрд┐рдХ рд╣рд┐рд░рд╛рд╕рдд: 14 рджрд┐рди (рдЖрдЧреЗ рдХреА рдЬрд╛рдВрдЪ рдХреЗ рд▓рд┐рдП)
- 22-03-2024: рдЕрд╕реНрдкрддрд╛рд▓ рдореЗрдВ рдЖрд░реЛрдкрд┐рдпреЛрдВ рдХреА рдореЗрдбрд┐рдХрд▓ рдЬрд╛рдВрдЪ (рд╕рдм рд╕реНрд╡рд╕реНрде)

рдЕрднрд┐рд░рдХреНрд╖рд╛ рдЕрднрд┐рд▓реЗрдЦ (Custody Record):
рдХреБрд▓ рд╣рд┐рд░рд╛рд╕рдд рдЕрд╡рдзрд┐: 14 рджрд┐рди (рдорд╛рдирдиреАрдп рдиреНрдпрд╛рдпрд╛рдзреАрд╢ рджреНрд╡рд╛рд░рд╛ рдЕрдиреБрдореЛрджрд┐рдд)
рдкреВрдЫрддрд╛рдЫ рд╡рд┐рд╡рд░рдг:
1. рд░рд╛рдо рдХреБрдорд╛рд░: 8 рдШрдВрдЯреЗ рдХреА рдкреВрдЫрддрд╛рдЫ тЖТ рдЕрдкрд░рд╛рдз рд╕реНрд╡реАрдХрд╛рд░ рдХрд┐рдпрд╛
2. рдЕрдирд┐рд▓ рдкрдЯреЗрд▓: 6 рдШрдВрдЯреЗ рдХреА рдкреВрдЫрддрд╛рдЫ тЖТ рдЖрдзрд╛ рдорд╛рдирд╛
3. рдкреНрд░рдХрд╛рд╢ рд╕реЛрдиреА: 4 рдШрдВрдЯреЗ рдХреА рдкреВрдЫрддрд╛рдЫ тЖТ рд╕рд╣рдпреЛрдЧ рджрд┐рдпрд╛

рдЕрддрд┐рд░рд┐рдХреНрдд рдЬрд╛рдирдХрд╛рд░реА:
- рд╕рднреА рдЖрд░реЛрдкреА рдкреВрд░реНрд╡ рдЕрдкрд░рд╛рдзреА рд╣реИрдВ
- рдЫрддреНрддреАрд╕рдЧрдврд╝ рдкреБрд▓рд┐рд╕ рдореЗрдВ рд░рд┐рдХреЙрд░реНрдб: рдмрдбреМрдж рдХрд╛ рдЗрддрд┐рд╣рд╛рд╕
- рдмреЗрд▓ рдХреЗ рд▓рд┐рдП рдЖрд╡реЗрджрди: rejected
- рдЕрдкреАрд▓ рджрд╛рдпрд░ рдХреА рдЧрдИ: High Court рдореЗрдВ рд▓рдВрдмрд┐рдд

рдЕрдиреНрд╡реЗрд╖рдг рдкреВрд░реНрдг:
рдЕрдиреНрд╡реЗрд╖рдг рдХрд╛ рдХреНрд╖реЗрддреНрд░рдлрд▓: 15 рджрд┐рди (12/03/2024 рд╕реЗ 27/03/2024)
рдкреНрд░рдердо рд╕реВрдЪрдирд╛ рдкреНрд░рддрд┐рд╡реЗрджрди (FIR) рд╕рддреНрдпрд╛рдкрд┐рдд
рд╕рднреА рд╕рд╛рдХреНрд╖реНрдп рд╕рдВрдЧреНрд░рд╣реАрдд
рд╕рднреА рд╕рд╛рдХреНрд╖рд┐рдпреЛрдВ рдХреЗ рдмрдпрд╛рди рджрд░реНрдЬ
рдЪрд╛рд░реНрдЬрд╢реАрдЯ рддреИрдпрд╛рд░: 27-03-2024
            """
            st.rerun()
    
    with col3:
        if st.button("ЁЯЧСя╕П Clear"):
            st.session_state.raw_text = ""
            st.rerun()
    
    # ================= FILE EXTRACTION =================
    extracted_from_file = ""
    if uploaded_file is not None:
        file_bytes = uploaded_file.read()
        filename = uploaded_file.name
        
        st.info(f"ЁЯУВ Processing file: **{filename}**...")
        
        result = extract_text_from_file(file_bytes, filename)
        
        if "error" in result:
            st.error(f"тЭМ {result['error']}")
        else:
            extracted_from_file = result.get("text", "")
            file_format = result.get("format", "unknown")
            st.success(f"тЬЕ Extracted from **{file_format.upper()}** ({len(extracted_from_file)} characters)")
    
    # ================= TEXT INPUT =================
    raw_text_val = st.session_state.get("raw_text", "")
    raw_text = st.text_area(
        "Raw Text (or paste additional text):",
        value=raw_text_val,
        height=220,
        placeholder="Text will be auto-populated if you upload a file..."
    )
    
    # Combine file-extracted text and manual text
    final_text = extracted_from_file if extracted_from_file else raw_text

    # ================= PROCESS BUTTON =================
    if st.button("тЪЩя╕П Process Chargesheet", type="primary"):

        # API key check
        if not GEMINI_API_KEY:
            st.error("тЭМ GEMINI_API_KEY missing in .env file.")
            return

        # Text check
        if not final_text.strip():
            st.warning("тЪа Please upload a file or enter text to process.")
            return

        # ================= PROCESSING =================
        with st.spinner("ЁЯФД Processing chargesheet (extracting summary, classifying, checking items)..."):

            try:
                cleaned_text = clean_noisy_text(final_text)
                summary_data = extract_case_summary(cleaned_text)

                if "error" in summary_data:
                    st.error(summary_data["error"])
                    return

                legal_sections = summary_data.get("legal_sections", [])
                classification = classify_crime_type(legal_sections, checklists)

                checklist_results = run_missing_items_check(
                    cleaned_text,
                    classification["crime_type"],
                    checklists
                )

            except Exception as e:
                st.error(f"Unexpected error occurred: {e}")
                return

        # ================= OUTPUT =================

        st.divider()
        st.header("ЁЯУЛ A. Structured Case Summary")

        st.write(
            f"**FIR:** {summary_data.get('fir_details', 'N/A')}"
        )

        st.write(
            f"**Accused:** {', '.join(summary_data.get('accused', []))}"
        )

        st.write(
            f"**Sections:** {', '.join(summary_data.get('legal_sections', []))}"
        )

        st.write(
            f"**Facts:** {summary_data.get('incident_facts', 'N/A')}"
        )

        st.divider()
        st.header("ЁЯП╖я╕П B. Crime Classification")

        if classification["crime_type"] == "UNKNOWN":
            st.warning(classification.get("reason", "Unknown classification"))
        else:
            st.success(classification.get("display_name", "Classified"))

        st.divider()
        st.header("тЬЕ C. Missing Items")

        if not checklist_results:
            st.info("No checklist available for this crime type.")
        else:
            for res in checklist_results:
                status = res.get("status", "")
                item = res.get("item", "")

                if "тЬЕ" in status:
                    st.success(f"{status} | {item}")
                elif "тЪа" in status:
                    st.warning(f"{status} | {item}")
                else:
                    st.error(f"{status} | {item}")


# ================= RUN APP =================
if __name__ == "__main__":
    main()